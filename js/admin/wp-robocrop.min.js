!function(t){var e=_.extend(window.robocrop,{cropFromFocusPoint:function(t,e){var i=(t.focuspoint.x+1)/2*t.width,o=(1-t.focuspoint.y)/2*t.height,s=Math.min(t.width/e.min_width,t.height/e.min_height),n=e.min_width*s,s=e.min_height*s,i=Math.min(Math.max(i-n/2,0),t.width-n),o=Math.min(Math.max(o-s/2,0),t.height-s);return{names:e.sizes,x:i/t.width,y:o/t.height,width:n/t.width,height:s/t.height}},relToAbsCoords:function(t,e){var i,o={};for(i in t)switch(i){case"x":case"x1":case"x2":case"width":o[i]=t[i]*e.width;break;case"y":case"y1":case"y2":case"height":o[i]=t[i]*e.height;break;default:o[i]=t[i]}return o},absToRelCoords:function(t,e){var i,o={};for(i in t)switch(i){case"x":case"x1":case"x2":case"width":o[i]=t[i]/e.width;break;case"y":case"y1":case"y2":case"height":o[i]=t[i]/e.height;break;default:o[i]=t[i]}return o},pointToRectCoords:function(t){return{x:parseFloat(t.x1),y:parseFloat(t.y1),width:parseFloat(t.x2)-parseFloat(t.x1),height:parseFloat(t.y2)-parseFloat(t.y1)}},rectToPointCoords:function(t){return{x1:parseFloat(t.x),y1:parseFloat(t.y),x2:t.maxX?parseFloat(t.maxX):parseFloat(t.x)+parseFloat(t.width),y2:t.maxY?parseFloat(t.maxY):parseFloat(t.y)+parseFloat(t.height)}},view:{},controller:{}});t.media.robocrop=e}(wp),function(o,n){var a=o.media.robocrop,t=a.image_ratios,c=a.image_sizes,e=a.l10n;a.options;a.view.Img=o.media.View.extend({className:"attachment-image",tagName:"img",id:"robocrop-image",initialize:function(){var t=this;_.defaults(this.options,{src:""}),this.$el.on("load",function(){t.width=t.$el.get(0).naturalWidth,t.height=t.$el.get(0).naturalHeight,t.ratio=t.width/t.height,t.trigger("load",t)}),this.$el.attr("src",this.options.src)},getSrc:function(t){return this.$el.attr("src")},setSrc:function(t){return t&&this.$el.attr("src",t),this}}),a.view.RobocropRatioSelect=o.media.View.extend({className:"robocrop-select",template:o.template("robocrop-select"),events:{'change [name="robocrop-select-ratio"]':"selectRatio"},initialize:function(){o.Backbone.View.prototype.initialize.apply(this,arguments),_.defaults({ratios:{},tools:{}},this.options),this.options.l10n=e},render:function(){o.Backbone.View.prototype.render.apply(this,arguments);var s=this;_.each(this.options.tools,function(t,e){s.views.add(new a.view.RobocropRatioSelectItem({ratiokey:e,sizenames:!1,ratio:e,title:t.title,enabled:!0}))}),_.each(this.options.ratios,function(t,e){var i=[],o=_.template('<span class="sizename<%= cancrop ? "" : " disabled" %>"><%= name %> (<%= width %>Ã—<%= height %>)</span>');_.each(t.sizes,function(t,e){t=n.extend(!0,{cancrop:s.model.get("width")>=c[t].width&&s.model.get("height")>=c[t].height},c[t]);t.crop&&i.push(o(t))}),s.views.add(new a.view.RobocropRatioSelectItem({ratiokey:e,sizenames:i.join(""),ratio:t.ratio,title:t.name,enabled:s.model.get("width")>=t.min_width&&s.model.get("height")>=t.min_height}))})},setSelected:function(t){this.$el.find('[name="robocrop-select-ratio"][value="'+t+'"]').prop("checked",!0),this.selectRatio()},getSelected:function(){return this.$el.find('[name="robocrop-select-ratio"]:checked').val()},selectRatio:function(t){this.options.ratios[this.getSelected()]?this.trigger("select-ratio"):this.options.tools[this.getSelected()]&&this.trigger("select-tool"),this.trigger("select")}}),a.view.RobocropRatioSelectItem=o.media.View.extend({className:"robocrop-select-item",template:o.template("robocrop-select-item"),sizekey:"",sizenames:"",ratio:0,enabled:null,render:function(){o.Backbone.View.prototype.render.apply(this,arguments),1<this.options.ratio?this.$el.find(".format-indicator").height(1/this.options.ratio+"em"):this.options.ratio<1&&this.$el.find(".format-indicator").width(this.options.ratio+"em"),this.$el.find('input[type="radio"]').prop("disabled",!this.options.enabled)}}),a.view.RobocropImage=o.media.View.extend({className:"image-robocrop",template:o.template("robocrop"),image_ratios:t,image_sizes:c,_croppers:null,events:{"click .robocrop-autocrop-current":"autocrop","click .robocrop-autocrop-all":"autocropAll"},initialize:function(t){this._croppers={},this.image=new a.view.Img({src:this.model.get("original_url")}),this.controller=t.controller,this.focuspointtool=new a.view.focuspoint.ImageFocusPointSelect({image:this.image,focuspoint:{x:0,y:0},src:this.model.get("url")}),this.listenTo(this.focuspointtool,"changed",this.updateFocusPoint),o.media.View.prototype.initialize.apply(this,arguments)},dismiss:function(){var t=this.$areaSelect();t&&t.remove(),this.$el.remove()},createSelect:function(){this.select=new a.view.RobocropRatioSelect({choices:choices})},hasChanged:function(){this.trigger("changed")},render:function(){var i=this;return o.media.View.prototype.render.apply(this,arguments),this.views.set(".robocrop-content",this.focuspointtool),this.focuspointtool.setFocuspoint(this.model.get("focuspoint")),this.image.$el.imgAreaSelect({parent:this.image.$el.closest(".robocrop-image-box"),instance:!0,handles:!0,keys:!0,persistent:!0,enabled:!0,movable:!0,resizable:!0,imageHeight:this.model.get("height"),imageWidth:this.model.get("width"),onSelectEnd:function(t,e){e=a.pointToRectCoords(e);i._setCropSizes(e),i.hasChanged()}}),this.selectRatio=new a.view.RobocropRatioSelect({tools:{focuspoint:{title:e.SetFocusPoint,trigger:"focuspoint"}},ratios:this.image_ratios,model:this.model}),this.selectRatio.on("select-ratio",this.onselectratio,this).on("select-tool",this.onselecttool,this).on("select",this.updateButtons,this),this.views.set(".select-ratio",this.selectRatio),this.$autoButton=this.$el.find(".robocrop-autocrop-current"),this.$autoAllButton=this.$el.find(".robocrop-autocrop-all"),this},ready:function(){var t,e;return o.media.view.EditImage.prototype.ready.apply(this,arguments),_.isUndefined(this.options.sizeToSelect)||(e=_.find(this.image_ratios,function(t){return-1<t.sizes.indexOf(this.options.sizeToSelect)},this))&&(t=e.name),_.isUndefined(t)&&(t="focuspoint"),this.selectRatio.setSelected(t),this},save:function(){var t={attachments:{}},e=this.model.get("id"),i=this.$autoAllButton.add(this.$autoButton).prop("disabled",!0),o=this;return t.attachments[e]={sizes:this.model.get("sizes"),focuspoint:this.model.get("focuspoint")},this.model.saveCompat(t,{}).done(function(t){var s=new Date;_.each(o.model.attributes.sizes,function(t,e){function i(){n(this).removeAttr("src").attr("src",t.url+"?"+s.getTime())}var o='img[src^="'+t.url+'"]';refresh_mce=function(){n(this).removeAttr("data-mce-src").attr("data-mce-src",t.url+"?"+s.getTime())},"full"!==e&&(n(document).add(n("iframe").contents()).find(o).each(i),n(".mce-edit-area iframe").each(function(){n(this).contents().find(o).each(i).each(refresh_mce)}))},o),i.prop("disabled",!1),o.trigger("saved")}),this},updateButtons:function(){var t=this.selectRatio.getSelected();this.$autoButton.toggleClass("hidden","focuspoint"===t),this.$autoAllButton.toggleClass("hidden","focuspoint"!==t)},onselecttool:function(){var t=this.selectRatio.getSelected();this.$areaSelect().cancelSelection(),"focuspoint"===t&&this.focuspointtool.setEnabled(!0)},onselectratio:function(){this.focuspointtool.setEnabled(!1);var e,i,t,o=this.selectRatio.getSelected(),s=this.model.get("sizes"),n=this,a=this.model.get("width"),r=this.model.get("height");return this.current_ratio=this.image_ratios[o],i={aspectRatio:this.current_ratio.ratio+":1",minWidth:this.current_ratio.min_width,minHeight:this.current_ratio.min_height},_.each(this.current_ratio.sizes,function(t){!e&&s[t]&&s[t].cropdata&&(e=s[t].cropdata),c[t].width<=a&&c[t].height<=r&&(i.minWidth=Math.max(i.minWidth,c[t].width),i.minHeight=Math.max(i.minHeight,c[t].height))}),e?(t={},_.extend(t,e)):(o=Math.min(this.model.get("width")/this.current_ratio.ratio,this.model.get("height")),(t={x:0,y:0,width:o*this.current_ratio.ratio,height:o}).x=(this.model.get("width")-t.width)/2,t.y=(this.model.get("height")-t.height)/2),this.$areaSelect().setOptions(i),this.image.$el.get(0).complete?this.selectCrop(t):this.image.$el.on("load",function(){n.selectCrop(t)}),this},autocrop:function(t){var e={width:this.model.get("width"),height:this.model.get("height"),focuspoint:this.model.get("focuspoint")},i=a.cropFromFocusPoint(e,this.current_ratio);return i=a.relToAbsCoords(i,e),this._setCropSizes(i),this.selectCrop(i),this},autocropAll:function(t){var i=this,o={width:this.model.get("width"),height:this.model.get("height"),focuspoint:this.model.get("focuspoint")};return _.each(this.image_ratios,function(t){var e=a.cropFromFocusPoint(o,t);e=a.relToAbsCoords(e,o),i._setCropSizes(e,t)}),this},selectCrop:function(t){var t=a.rectToPointCoords(t),e=this.$areaSelect();return e.setSelection(t.x1,t.y1,t.x2,t.y2,!1),e.setOptions({show:!0}),e.update(),this},$areaSelect:function(){return this.image.$el.data("imgAreaSelect")},_image_scale_factor:function(){var t=this.image.$el.closest(".robocrop-image-box"),e=Math.min(this.model.get("width"),t.width()),t=Math.min(this.model.get("height"),t.height());return Math.min(e/this.model.get("width"),t/this.model.get("height"))},updateFocusPoint:function(){this.model.set("focuspoint",this.focuspointtool.getFocuspoint())},_setCropSizes:function(e,t){this.model.get("width"),this.model.get("height");var i=this.model.get("sizes"),t=t||this.current_ratio;_.each(t.sizes,function(t){i[t]||(i[t]={}),i[t].cropdata=e,c[t].crop?i[t].cropdata=e:void 0!==i[t]&&delete i[t]}),this.model.set("sizes",i)},_getRelativeCoords:function(t){var e,i=this.model.get("width"),o=this.model.get("height");for(e in t)if("number"==typeof t[e])switch(e){case"x":case"x1":case"x2":case"width":case"minX":case"maxX":t[e]/=i;break;default:t[e]/=o}},_getAbsoluteCoords:function(t){var e,i=this.model.get("width"),o=this.model.get("height");for(e in t)if("number"==typeof t[e])switch(e){case"x":case"x1":case"x2":case"width":case"minX":case"maxX":t[e]*=i;break;default:t[e]*=o}}}),a.view.Frame=o.media.view.MediaFrame.extend({template:o.template("robocrop-modal"),regions:["title","content","instructions","buttons","ratios"]}),a.view.Frame.Crop=a.view.Frame.extend({events:{"click .robocrop-save":"save","click .robocrop-cancel":"close"},save:function(){this.$(".robocrop-save, .robocrop-cancel").prop("disabled",!0),this._content.save()},initialize:function(t){a.view.Frame.prototype.initialize.apply(this,arguments),this.createStates(),this.createContent(),this.createButtons(),this.on("close",this.dismiss,this),this.listenTo(this._content,"saved",this.modelSync)},createStates:function(){this.states.add([new o.media.controller.State({id:"robocrop",model:this.model,library:this.library,view:this,title:e.AttachmentDetails})])},modelSync:function(){this.$(".robocrop-save, .robocrop-cancel").prop("disabled",!1)},dismiss:function(){this._content.dismiss()},createContent:function(){var t=_.extend({controller:this.controller,model:this.model},this.options);this._content=new a.view.RobocropImage(t),this.content.set([this._content])},createButtons:function(){this.buttons.set([new o.media.view.Button({text:e.Close,className:"button-secondary robocrop-cancel"}),new o.media.view.Button({text:e.SaveChanges,className:"button-primary robocrop-save"})])}})}(wp,jQuery),function(t,e){var o,s,n=t.media.robocrop,a=n.image_ratios,i=(n.image_sizes,n.l10n),r=t.media.View;t.media.view.MediaFrame;n.view.focuspoint={},s=n.view.focuspoint.CropRect=r.extend({template:t.template("croprect"),className:"tool-croprect",controller:null,events:{"mouseenter .label":"showHilite","mouseleave .label":"hideHilite"},initialize:function(){return r.prototype.initialize.apply(this,arguments),_.defaults(this.options,{focuspoint:null,ratio:null}),this.options.label=this.options.ratio.name,this.controller=this.options.controller,this.listenTo(this.controller.image,"load",this.imageLoaded),this},imageLoaded:function(t){this.$el.attr("data-dir",this.options.ratio.ratio>t.ratio?"w":"h"),this.$el.css("width",100*Math.min(1,this.options.ratio.ratio/t.ratio)+"%"),this.setFocuspoint()},setFocuspoint:function(t){t&&(this.options.focuspoint=t);var t={width:this.controller.image.$el.width(),height:this.controller.image.$el.height(),focuspoint:this.options.focuspoint},e=n.cropFromFocusPoint(t,this.options.ratio),e=n.relToAbsCoords(e,t);return this.$el.css("left",e.x+"px"),this.$el.css("top",e.y+"px"),this},showHilite:function(t){return this.$el.attr("data-hilite","true"),this.trigger("hilite:show"),this},hideHilite:function(t){return this.$el.attr("data-hilite","false"),this.trigger("hilite:hide"),this}}),o=n.view.focuspoint.FocusPoint=r.extend({className:"tool-focuspoint",template:t.template("focuspoint"),labelView:null,initialize:function(){var e=this;return _.defaults(this.options,{focuspoint:{x:0,y:0},enabled:!1,cropRects:[]}),this.options.cropRects.sort(function(t,e){return e.options.ratio.ratio-t.options.ratio.ratio}),this.$el.on("click",function(t){e.clickFocuspoint(t)}),this},render:function(){var e=this;return r.prototype.render.apply(this,arguments),_.each(this.options.cropRects,function(t){t.render(),e.$el.append(t.$el)}),this},setEnabled:function(t){var e=this.options.enabled;return this.options.enabled=t,this.$el.attr("data-enabled",t.toString()),e},clickFocuspoint:function(t){var e;this.options.enabled&&(e=this.$el.offset(),this.setFocuspoint({x:2*(t.pageX-e.left)/this.$el.width()-1,y:-2*(t.pageY-e.top)/this.$el.height()+1}))},getFocuspoint:function(){return this.focuspoint},setFocuspoint:function(t){var e=this;return t.x=parseFloat(t.x),t.y=parseFloat(t.y),this.focuspoint=t,this.$el.find(".focuspoint").css({left:50*(t.x+1)+"%",bottom:50*(t.y+1)+"%"}),_.each(this.options.cropRects,function(t){t.setFocuspoint(e.focuspoint)}),this.options.enabled&&this.trigger("change:focuspoint",this.focuspoint),this}}),n.view.focuspoint.ImageFocusPointSelect=r.extend({className:"robocrop-image-box",cropRects:[],initialize:function(){_.defaults(this.options,{controller:this,focuspoint:{x:0,y:0},src:!1,image:!1,enabled:!1});var i=this;return!1!==this.options.image&&this.options.image.constructor.prototype==n.view.Img.prototype?this.image=this.options.image:!1!==this.options.src?this.image=new n.view.Img({src:this.options.src}):this.image=new n.view.Img({src:""},this.options.image),this.cropRects=[],_.each(a,function(t,e){t=new s({controller:i,focuspoint:i.options.focuspoint,ratio:t});i.listenTo(t,"hilite:show",i.showHilite),i.listenTo(t,"hilite:hide",i.hideHilite),i.cropRects.push(t)}),this.focuspoint=new o({controller:this.controller,focuspoint:this.options.focuspoint,enabled:this.options.enabled,cropRects:this.cropRects}),this.listenTo(this.focuspoint,"change:focuspoint",this.valueChanged),this.listenTo(this.image,"load",this.setHeight),this.views.set([this.image,this.focuspoint]),this},setHeight:function(){var t=Math.min(this.$el.parent().height(),this.image.$el.height());this.$el.height(t)},setEnabled:function(t){return this.focuspoint.setEnabled(t)},getFocuspoint:function(){return this.focuspoint.getFocuspoint()},setFocuspoint:function(t){return this.focuspoint&&this.focuspoint.setFocuspoint(t),this},getImageWidth:function(){return this.image.$el.get(0).naturalWidth},getImageHeight:function(){return this.image.$el.get(0).naturalHeight},setSrc:function(t){return this.image.$el.attr("src",t),this},valueChanged:function(){this.trigger("changed")},showHilite:function(t){this.$el.attr("data-hilite","true")},hideHilite:function(t){this.$el.attr("data-hilite","false")}}),n.view.Frame.Focuspoint=n.view.Frame.extend({className:"ask-focuspoint media-frame",events:{"click .reset":"reset","click .proceed":"proceed","click .cancel-upload":"cancelUpload"},initialize:function(){return _.defaults(this.options,{uploader:!1,title:i.SetFocusPoint,modal:!!this.options&&this.options.modal,src:""}),n.view.Frame.prototype.initialize.apply(this,arguments),this.modal&&this.modal.on("escape",this.cancelUpload,this),this.createStates(),this.createContent(),this.createInstructions(),this.createButtons(),this},createStates:function(){this.states.add([new t.media.controller.State({id:"robocrop",model:this.model,library:this.library,view:this,title:i.AttachmentDetails})])},createContent:function(){this._content=new n.view.focuspoint.ImageFocusPointSelect({src:"",focuspoint:{x:0,y:0},controller:this,enabled:!0,toolbar:this.tools}),this.content.set([this._content])},createInstructions:function(){this.instructions.set([new t.media.View({el:e('<div class="instructions">'+i.FocusPointInstructions+"</div>")[0],priority:-40})])},createButtons:function(){this.buttons.set([new t.media.view.Button({text:i.Cancel,className:"cancel-upload"}),new t.media.view.Button({text:i.Reset,className:"reset"}),new t.media.view.Button({text:i.Upload,className:"button-primary proceed"})])},setSrc:function(t){this._content.setSrc(t)},setFile:function(t){var e=this,i=new FileReader;i.onload=function(t){e.setSrc(i.result)},i.readAsDataURL(t)},setFocuspoint:function(t){this._content.setFocuspoint(t),this._content.setEnabled(!0)},getFocuspoint:function(){return this._content.getFocuspoint()},getImageWidth:function(){return this._content.getImageWidth()},getImageHeight:function(){return this._content.getImageHeight()},reset:function(t){this.setFocuspoint({x:0,y:0})},proceed:function(t){this.trigger("proceed")},cancelUpload:function(t){this.trigger("cancel-upload"),this.close()}})}(wp,jQuery),function(t,e){var i=t.media.robocrop,o=(i.image_ratios,i.image_sizes,i.l10n),s=(i.options,'<button type="button" class="button robocrop-open">'+o.EditImageSizes+"</button>"),n='<button type="button" class="button-link robocrop-open">'+o.EditImageSizes+"</button>",o={createStates:function(){this._parentCreateStates.apply(this,arguments),this.states.add(new i.controller.RobocropImage({model:this.model,selection:this.options.selection}))}};_.extend(t.media.view.ImageDetails.prototype,{_parentPostRender:t.media.view.ImageDetails.prototype.postRender,postRender:function(){this._parentPostRender.apply(this,arguments),this.$el.find(".actions").append(s)},robocropOpen:function(t){var e=this.model.get("size");new i.view.Frame.Crop({controller:this.controller,model:this.controller.image.attachment,sizeToSelect:e}).open()}}),t.media.view.ImageDetails.prototype.events["click .robocrop-open"]="robocropOpen",_.extend(t.media.view.Attachment.Details.prototype,{_parentRender:t.media.view.Attachment.Details.prototype.render,render:function(){this._parentRender.apply(this,arguments),0<=["image/jpeg","image/png","image/gif"].indexOf(this.model.get("mime"))&&(this.$(".attachment-actions").append(s),e(n).insertAfter(this.$el.find("a.edit-attachment")))},robocropOpen:function(t){new i.view.Frame.Crop({controller:this.controller,model:this.model,state:"robocrop"}).open()},_parentCreateStates:t.media.view.Attachment.Details.prototype.createStates},o),t.media.view.Attachment.Details.prototype.events["click .robocrop-open"]="robocropOpen"}(wp,jQuery),function(r){var c=wp.media.robocrop,s=c.image_ratios,t=c.options,h={};t.ask_for_focuspoint&&_.extend(wp.media.view.UploaderWindow.prototype,{_parentReady:wp.media.view.UploaderWindow.prototype.ready,didReady:!1,ready:function(){var n,a=[];return this.didReady?this._parentReady.apply(this,arguments):(this.didReady=!0,ret=this._parentReady.apply(this,arguments),this.uploader.uploader.bind("FilesAdded",function(t,e){for(var i,o,s=0;s<e.length;s++)"image/png"!=e[s].type&&"image/jpeg"!=e[s].type||(i=e[s],o=void 0,(o={file:i,blob:i.getNative()}).blob||(o.blob=i.getSource()),(i=o).blob instanceof Blob&&a.push(i));a.length&&(t.stop(),t.refresh(),function t(e){var i;n&&n.close().dispose(),a.length?(i=a.shift(),(n=new c.view.Frame.Focuspoint({controller:r(this),state:"robocrop"})).on("proceed",function(){h[i.file.name]={focuspoint:n.getFocuspoint(),width:n.getImageWidth(),height:n.getImageHeight()},t(e)}).on("cancel-upload",function(){i.file.attachment.destroy()}),n.setFocuspoint({x:0,y:0}),n.setFile(i.blob),n.open()):e.start()}(t),console.log("askfocus"))}),this.uploader.uploader.bind("BeforeUpload",function(t,e){var i,o;if(h[e.name]){for(i in imageinfo=h[e.name],o={},s)o[s[i].name]=c.cropFromFocusPoint(imageinfo,s[i]);t.settings.multipart_params.focuspoint=JSON.stringify(imageinfo.focuspoint),t.settings.multipart_params.cropdata=JSON.stringify(o),delete h[e.name]}}),ret)}})}(jQuery);